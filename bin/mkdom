#!/bin/bash
set -euo pipefail

if [ $# -lt 2 ]; then
	echo "Usage: $0 <name> <souce-img> [cidata.iso] [RAM=1536] [NCPU=1]"
	echo "Usage: Set [cidata.iso] to \"none\" for no image"
	exit
fi

dom=$1; shift
srcimg=$1; shift

# defaults
cidata=
ram=1536
ncpu=1

if [ $# -gt 0 ]; then
	cidata=$1; shift
fi

if [ $# -gt 0 ]; then
	ram=$1; shift
fi

if [ $# -gt 0 ]; then
	ncpu=$1; shift
fi

cat << EOF
Name    $dom
Source  $srcimg
cidata  $cidata
RAM     $ram
CPUs    $ncpu
EOF

# create the new image
newimg="/var/lib/libvirt/images/$dom.qcow2"

qemu-img create -f qcow2 -o backing_file="$srcimg" "$newimg"

# create the new domain
if [ -n "$cidata" ] && [ "$cidata" != "none" ]; then
	virt-install --import --name="$dom" --os-variant=rhel7 --ram="$ram" \
		--vcpus="$ncpu" --disk path="$newimg",format=qcow2,bus=virtio \
		--disk path="$cidata",device=cdrom,readonly=on \
		--network bridge=virbr0 --noautoconsole
else
	virt-install --import --name="$dom" --os-variant=rhel7 --ram="$ram" \
		--vcpus="$ncpu" --disk path="$newimg",format=qcow2,bus=virtio \
		--network bridge=virbr0 --noautoconsole
fi
